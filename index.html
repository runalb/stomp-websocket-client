<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>STOMP WebSocket Client by Runal Banarse</title>

  <!-- SockJS & STOMP -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="app-shell">
  <div class="card">
    <div class="card-header">
      <div>
        <h2 class="title">STOMP WebSocket Client</h2>
        <p class="subtitle">Developer: Runal Banarse</a></p>
      </div>
      <div class="badge">
        <span></span>
        <a href="https://runalb.com" target="_blank" class="brand-link">runalb.com</a>
      </div>
    </div>

    <div class="form-grid">
      <div class="field-group">
        <label for="wsUrl" class="field-label">WebSocket URL</label>
        <input
          id="wsUrl"
          class="field-input"
          value="https://unaiding-autumn-strident.ngrok-free.app/ws"
          placeholder="https://localhost:8080/ws"
        >
      </div>

      <div class="field-group">
        <label for="topics" class="field-label">Topics (comma separated)</label>
        <input
          id="topics"
          class="field-input"
          value="businessOutlet.1.UPDATE_TABLE_AREA"
          placeholder="businessOutlet.{businessOutletId}.{event}, example: businessOutlet.1.UPDATE_TABLE_AREA"
        >
      </div>

      <div class="field-group" style="grid-column: 1 / -1;">
        <div class="field-label">STOMP Topic URLs</div>
        <div id="exampleTopics" class="example-topics"></div>
      </div>

      <div class="button-row" style="grid-column: 1 / -1;">
        <button id="connectBtn" class="btn btn-primary" onclick="connect()">
          <span class="btn-label">Connect</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>
        <button class="btn btn-secondary" onclick="disconnect()">Disconnect</button>
      </div>
    </div>

    <div class="log-wrapper">
      <div class="log-label-row">
        <div>Event stream</div>
        <div class="log-meta">Subscribed STOMP topics &amp; messages</div>
      </div>
      <pre id="log"></pre>
    </div>
  </div>
</div>

<script>
  let stompClient = null;
  let isConnecting = false;

  function log(msg) {
    const el = document.getElementById("log");
    el.textContent += msg + "\n";
    el.scrollTop = el.scrollHeight;
  }

  function updateExampleTopics() {
    const topics = document.getElementById("topics").value
                    .split(",")
                    .map(t => t.trim())
                    .filter(t => t.length > 0);
    
    const exampleEl = document.getElementById("exampleTopics");
    
    if (topics.length === 0) {
      exampleEl.innerHTML = '<div class="example-topic-item">No topics specified</div>';
      return;
    }
    
    exampleEl.innerHTML = topics.map(topic => {
      const stompTopic = `/topic/${topic}`;
      return `<div class="example-topic-item">${stompTopic}</div>`;
    }).join('');
  }

  // Update examples when inputs change
  document.addEventListener("DOMContentLoaded", () => {
    updateExampleTopics();
    document.getElementById("topics").addEventListener("input", updateExampleTopics);
  });

  function connect() {
    // Prevent multiple connects while in progress or already connected
    if (isConnecting || (stompClient && stompClient.connected)) return;

    const wsUrl = document.getElementById("wsUrl").value;
    const topics = document.getElementById("topics").value
                    .split(",")
                    .map(t => t.trim())
                    .filter(t => t.length > 0);

    const connectBtn = document.getElementById("connectBtn");
    const connectLabel = connectBtn.querySelector(".btn-label");

    isConnecting = true;
    connectBtn.classList.add("btn-loading");
    connectBtn.disabled = true;
    connectLabel.textContent = "Connecting...";

    const socket = new SockJS(wsUrl);
    stompClient = Stomp.over(socket);
    stompClient.debug = null; // disable verbose logs

    stompClient.connect({}, () => {
      isConnecting = false;
      connectBtn.classList.remove("btn-loading");
      connectBtn.disabled = true;
      connectLabel.textContent = "Connected";

      log(`âœ… Connected: ${wsUrl}`);

      topics.forEach(topic => {
        const stompTopic = `/topic/${topic}`;
        stompClient.subscribe(stompTopic, message => {
          log(`ðŸ“© Received message on: ${stompTopic}\n    â†’ ${message.body}\n`);
        });
        log(`ðŸ”” Subscribed to: ${stompTopic}`);
      });

    }, error => {
      isConnecting = false;
      connectBtn.classList.remove("btn-loading");
      connectBtn.disabled = false;
      connectLabel.textContent = "Connect";

      log("âŒ Connection error: " + error);
    });
  }

  function disconnect() {
    const connectBtn = document.getElementById("connectBtn");
    const connectLabel = connectBtn.querySelector(".btn-label");

    isConnecting = false;
    connectBtn.classList.remove("btn-loading");

    if (stompClient) {
      stompClient.disconnect(() => {
        log("ðŸ”Œ Disconnected");
        connectBtn.disabled = false;
        connectLabel.textContent = "Connect";
        stompClient = null;
      });
    } else {
      connectBtn.disabled = false;
      connectLabel.textContent = "Connect";
    }
  }
</script>

</body>
</html>
